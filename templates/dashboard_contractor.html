{% extends "layout.html" %}

{% block title %}æ¥æ¡ˆäººå„€è¡¨æ¿{% endblock %}

{% block content %}

    <style>
        /* ä¸‰æ¬„ä½ˆå±€å®¹å™¨ */
        .filter-three-col-grid {
            display: grid;
            grid-template-columns: 1.4fr 1.2fr 0.8fr; /* è¨­å®šä¸‰æ¬„æ¯”ä¾‹ï¼šé ç®—ç•¥å¯¬ï¼Œæ’åºæœ€çª„ */
            gap: 25px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px dashed #eee;
        }

        /* æ¯å€‹æ¬„ä½çš„æ¨™é¡Œ */
        .filter-col-title {
            font-size: 0.95em;
            font-weight: bold;
            color: #1d3a5a; /* æ·±è—è‰² */
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ç¬¬ä¸€æ¬„ï¼šé ç®—è¼¸å…¥æ¡†åˆ— */
        .budget-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .budget-input-row input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        /* ç¬¬ä¸€æ¬„ï¼šå¿«é€ŸæŒ‰éˆ•ç¾¤çµ„ */
        .quick-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .tag-btn {
            background: #f0f4f8;
            border: 1px solid #dae1e7;
            border-radius: 15px;
            padding: 4px 12px;
            font-size: 0.85em;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tag-btn:hover {
            background: #e3f2fd;
            color: #1976d2;
            border-color: #bbdefb;
        }

        /* Radio é¸é …æ¨£å¼ (é€šç”¨) */
        .radio-item-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: #444;
            white-space: nowrap; /* é—œéµï¼šå¼·åˆ¶æ–‡å­—ä¸æ›è¡Œ */
        }
        .radio-item-label input[type="radio"] {
            accent-color: #1d3a5a; /* æ·±è—è‰²é¸å–åœˆ */
            cursor: pointer;
            margin: 0;
        }

        /* ç¬¬äºŒæ¬„ï¼šæ©«å‘æ’åˆ—çš„ Radio */
        .radio-list-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* é¸é …ä¹‹é–“çš„é–“è· */
        }

        /* ç¬¬ä¸‰æ¬„ï¼šå‚ç›´æ’åˆ—çš„ Radio */
        .radio-list-vertical {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* è‡ªè¨‚æ—¥æœŸå€å¡Š */
        .custom-date-box {
            margin-top: 10px;
            padding-left: 5px;
        }
        .custom-date-box input {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85em;
            color: #666;
        }

        /* æœå°‹æ¡†æ¨£å¼ä¿®æ­£ï¼šå¼·åˆ¶é å·¦ + ä¿®æ­£å…§è· */
        .sleek-search-bar input[type="text"] {
            text-align: left !important;
            padding-left: 20px !important;
        }

        /* ç¢ºä¿æç¤ºæ–‡å­— (Placeholder) ä¹Ÿå¼·åˆ¶é å·¦ */
        .sleek-search-bar input[type="text"]::placeholder {
            text-align: left !important;
        }
    </style>

    <div class="dashboard-welcome">
        <h2>æ­¡è¿å›ä¾†ï¼Œ{{ user.username }}</h2>
        <p class="subtitle">
            ç›®å‰å¸‚å ´ä¸Šæœ‰ 
            <strong class="highlight-text">{{ stats.open }}</strong> 
            å€‹é–‹æ”¾ä¸­çš„æ¡ˆä»¶ç­‰å¾…æ‚¨çš„ææ¡ˆï¼
        </p>
    </div>

    <div class="stats-overview-row">
        <a href="{{ url_for('get_contractor_dashboard') }}?status=open" 
           class="overview-card card-blue clickable-card {{ 'active-filter' if current_filter == 'open' else '' }}">
            <div class="stat-label" style="color:#1976d2;">å°‹æ‰¾æ–°æ¡ˆä»¶</div>
            <div class="stat-number" style="color:#333;">{{ stats.open }}</div>
        </a>

        <a href="{{ url_for('get_contractor_dashboard') }}?status=in_progress" 
           class="overview-card card-orange clickable-card {{ 'active-filter' if current_filter == 'in_progress' else '' }}">
            <div class="stat-label" style="color:#e65100;">åŸ·è¡Œè£½ä½œä¸­</div>
            <div class="stat-number" style="color:#333;">{{ stats.in_progress }}</div>
        </a>

        <a href="{{ url_for('get_contractor_dashboard') }}?status=pending_approval" 
           class="overview-card card-yellow clickable-card {{ 'active-filter' if current_filter == 'pending_approval' else '' }}">
            <div class="stat-label" style="color:#fbc02d;">ç­‰å¾…é©—æ”¶</div>
            <div class="stat-number" style="color:#333;">{{ stats.pending }}</div>
        </a>

        <a href="{{ url_for('get_contractor_dashboard') }}?status=completed" 
           class="overview-card card-gray clickable-card {{ 'active-filter' if current_filter == 'completed' else '' }}">
            <div class="stat-label" style="color:#616161;">ç´¯è¨ˆå·²çµæ¡ˆ</div>
            <div class="stat-number" style="color:#333;">{{ stats.completed }}</div>
        </a>
    </div>

    <div class="client-dashboard-grid"> 
        
        <div class="main-list-area">
            
            <div class="project-list-container">
                
                <div class="list-header">
                    <h3>
                        {% if current_filter == 'open' %} ğŸ” å°‹æ‰¾æ–°æ¡ˆä»¶
                        {% elif current_filter == 'in_progress' %} ğŸ”¨ æˆ‘æ­£åœ¨åŸ·è¡Œçš„å°ˆæ¡ˆ
                        {% elif current_filter == 'pending_approval' %} â±ï¸ ç­‰å¾…å§”è¨—äººé©—æ”¶
                        {% elif current_filter == 'completed' %} ğŸ† æˆ‘çš„çµæ¡ˆç´€éŒ„
                        {% endif %}
                    </h3>
                    <span class="badge-count">å…± {{ projects|length }} ç­†</span>
                </div>

                {% if current_filter == 'open' %}
                <div style="padding: 20px 25px 0 25px;">
                    <form action="{{ url_for('get_contractor_dashboard') }}" method="get" id="filterForm">
                        <input type="hidden" name="status" value="open">
            
                        <div class="sleek-search-bar">
                            <div class="search-input-wrapper">
                                <input type="text" name="q" value="{{ request.query_params.get('q', '') }}" 
                                       placeholder="è¼¸å…¥é—œéµå­—æœå°‹æ¡ˆä»¶ (ä¾‹å¦‚: Logo, ç¶²ç«™) ...">
                            </div>
                            <button type="button" onclick="toggleFilters()" class="btn btn-secondary" style="border-radius: 30px; margin-left: 10px; white-space: nowrap;">
                                ç¯©é¸æ¢ä»¶ <span id="filterArrow">â–¼</span>
                            </button>
                            <button type="submit" class="btn-search" style="margin-left: 10px;">æœå°‹</button>
                        </div>

                        <div id="advancedFilters" class="filter-panel" style="display: none; margin-top: 20px; border-radius: 8px;">
                            
                            <div class="filter-three-col-grid">
                                
                                <div class="filter-col">
                                    <div class="filter-col-title">é ç®—ç¯„åœ</div>
                                    <div class="budget-input-row">
                                        <input type="number" id="minBudget" name="min_budget" placeholder="æœ€ä½" value="{{ request.query_params.get('min_budget', '') }}">
                                        <span style="color:#999;">~</span>
                                        <input type="number" id="maxBudget" name="max_budget" placeholder="æœ€é«˜" value="{{ request.query_params.get('max_budget', '') }}">
                                    </div>
                                    <div class="quick-tags">
                                        <button type="button" onclick="setBudget(null, 5000)" class="tag-btn">5k ä»¥ä¸‹</button>
                                        <button type="button" onclick="setBudget(5000, 10000)" class="tag-btn">5k - 1è¬</button>
                                        <button type="button" onclick="setBudget(10000, 50000)" class="tag-btn">1è¬ - 5è¬</button>
                                        <button type="button" onclick="setBudget(null, null)" class="tag-btn" style="background:#fff;">æ¸…é™¤</button>
                                    </div>
                                </div>

                                <div class="filter-col">
                                    <div class="filter-col-title">ææ¡ˆæˆªæ­¢</div>
                                    <div class="radio-list-horizontal">
                                        <label class="radio-item-label">
                                            <input type="radio" name="deadline_days" value="3" {% if request.query_params.get('deadline_days') == '3' %}checked{% endif %}>
                                            3 å¤©å…§
                                        </label>
                                        <label class="radio-item-label">
                                            <input type="radio" name="deadline_days" value="7" {% if request.query_params.get('deadline_days') == '7' %}checked{% endif %}>
                                            7 å¤©å…§
                                        </label>
                                        <label class="radio-item-label">
                                            <input type="radio" name="deadline_days" value="14" {% if request.query_params.get('deadline_days') == '14' %}checked{% endif %}>
                                            14 å¤©å…§
                                        </label>
                                        <label class="radio-item-label">
                                            <input type="radio" name="deadline_days" value="custom" id="customDeadlineRadio" onchange="toggleCustomDate(true)" {% if request.query_params.get('deadline_days') == 'custom' %}checked{% endif %}> 
                                            è‡ªè¨‚æ—¥æœŸ
                                        </label>
                                    </div>
                                    <div id="customDateContainer" class="custom-date-box" style="display: none;">
                                        <input type="date" name="custom_deadline" value="{{ request.query_params.get('custom_deadline', '') }}">
                                    </div>
                                </div>

                                <div class="filter-col">
                                    <div class="filter-col-title">æ’åºæ–¹å¼</div>
                                    <div class="radio-list-vertical">
                                        <label class="radio-item-label">
                                            <input type="radio" name="sort" value="newest" {% if request.query_params.get('sort') == 'newest' or not request.query_params.get('sort') %}checked{% endif %}>
                                            æœ€æ–°ç™¼å¸ƒ
                                        </label>
                                        <label class="radio-item-label">
                                            <input type="radio" name="sort" value="deadline" {% if request.query_params.get('sort') == 'deadline' %}checked{% endif %}>
                                            æˆªæ­¢æ—¥æœŸæœ€è¿‘
                                        </label>
                                        <label class="radio-item-label">
                                            <input type="radio" name="sort" value="budget_high" {% if request.query_params.get('sort') == 'budget_high' %}checked{% endif %}>
                                            é ç®—ç”±é«˜åˆ°ä½
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-actions" style="display: flex; justify-content: flex-end; gap: 15px;">
                                <a href="{{ url_for('get_contractor_dashboard') }}?status=open" 
                                    class="btn btn-secondary btn-sm">
                                    æ¸…é™¤æ‰€æœ‰æ¢ä»¶
                                </a>
                                <button type="submit" class="btn btn-primary btn-sm">å¥—ç”¨ç¯©é¸</button>
                            </div>
                        </div>
                    </form>
                </div>
                {% endif %}
                <div class="list-body">
                    {% if projects %}
                        {% for project in projects %}
                        <div class="project-item">
                            <div class="project-main-info">
                                <div class="project-title-row">
                                    <h4 class="project-name">{{ project.title }}</h4>
                                    
                                    {% if current_filter == 'open' %}
                                        {% if project.has_proposed %}
                                            <span class="status-badge-sm badge-blue">âœ… å·²æŠ•æ¨™</span>
                                        {% else %}
                                            <span class="status-badge-sm badge-green">é–‹æ”¾ä¸­</span>
                                        {% endif %}
                                    {% else %}
                                        {% if project.status == 'in_progress' %}
                                            <span class="status-badge-sm badge-orange">åŸ·è¡Œä¸­</span>
                                        {% elif project.status == 'rejected' %}
                                            <span class="status-badge-sm badge-red">é ˆä¿®æ”¹</span>
                                        {% elif project.status == 'pending_approval' %}
                                            <span class="status-badge-sm badge-yellow">å¾…é©—æ”¶</span>
                                        {% elif project.status == 'completed' %}
                                            <span class="status-badge-sm badge-gray">å·²çµæ¡ˆ</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                    
                                <div class="project-meta-row">
                                    <span>
                                        å§”è¨—äººï¼š
                                        <a href="{{ url_for('view_user_profile', user_id=project.client_id) }}" 
                                            class="user-link">
                                            {{ project.client_name }}
                                        </a>
                                    </span>
                                    <span class="divider">|</span>
                                        
                                    <span style="color: #2e7d32; font-weight: bold;">
                                        ğŸ’° {{ project.budget if project.budget else 'é ç®—æœªå…¬é–‹' }}
                                    </span>
                                    <span class="divider">|</span>

                                    <span>
                                        {% if project.deadline %}
                                            æˆªæ­¢ï¼š{{ project.deadline.strftime('%Y/%m/%d') }}
                                        {% else %}
                                            ç„¡æˆªæ­¢æœŸé™
                                        {% endif %}
                                    </span>
                                </div>
                                
                                {% if current_filter == 'open' %}
                                <p style="margin: 8px 0 0 0; color: #777; font-size: 0.9em; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                                    {{ project.description }}
                                </p>
                                {% endif %}
                            </div>
                                
                            <div class="project-action">
                                <a href="{{ url_for('get_contractor_project_details', project_id=project.id) }}" 
                                    class="btn btn-secondary btn-sm">
                                    {% if current_filter == 'open' %}
                                        è©³æƒ… / å ±åƒ¹
                                    {% else %}
                                        ç®¡ç†å°ˆæ¡ˆ
                                    {% endif %}
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-list-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>
                                {% if current_filter == 'open' and request.query_params.get('q') %}
                                    æ‰¾ä¸åˆ°ç¬¦åˆã€Œ{{ request.query_params.get('q') }}ã€çš„æ¡ˆä»¶ã€‚
                                {% elif current_filter == 'open' %}
                                    ç›®å‰å¸‚å ´ä¸Šæ²’æœ‰é–‹æ”¾ä¸­çš„æ¡ˆä»¶ã€‚
                                {% else %}
                                    æ­¤åˆ†é¡ä¸‹ç›®å‰æ²’æœ‰å°ˆæ¡ˆã€‚
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div> 
        </div>

        <div class="side-action-area">
            
            <div class="project-list-container">
                <div class="list-header">
                    <h3>ğŸ’¡ æ¥æ¡ˆå°æ’‡æ­¥</h3>
                </div>
                <div class="list-body scrollable-list-body">
                    
                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <span>ğŸ‘‰ å¦‚ä½•å¯«å‡ºå¥½ææ¡ˆï¼Ÿ</span>
                            <span class="accordion-arrow">&rsaquo;</span>
                        </div>
                        <div class="accordion-content">
                            <p>å¸å¼•äººçš„ææ¡ˆæ‡‰è©²åŒ…å«ï¼š</p>
                            <ul>
                                <li><strong>é‡å°æ€§ï¼š</strong>ç›´æ¥å›æ‡‰å§”è¨—äººçš„æ ¸å¿ƒéœ€æ±‚ï¼Œé¿å…ç½é ­è¨Šæ¯ã€‚</li>
                                <li><strong>å¯¦åŠ›è­‰æ˜ï¼š</strong>é™„ä¸Šèˆ‡è©²å°ˆæ¡ˆé«˜åº¦ç›¸é—œçš„éå¾€ä½œå“é›†ã€‚</li>
                                <li><strong>æ˜ç¢ºå ±åƒ¹ï¼š</strong>åˆ—å‡ºé ç®—åˆ†é…èˆ‡é è¨ˆå·¥æ™‚ï¼Œå±•ç¾å°ˆæ¥­åº¦ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <span>ğŸ‘‰ å°ˆæ¡ˆåŸ·è¡Œæ³¨æ„äº‹é …</span>
                            <span class="accordion-arrow">&rsaquo;</span>
                        </div>
                        <div class="accordion-content">
                            <p>é †åˆ©çµæ¡ˆçš„é—œéµåœ¨æ–¼æºé€šï¼š</p>
                            <ul>
                                <li><strong>ä¸»å‹•å›å ±ï¼š</strong>å®šæœŸæ›´æ–°é€²åº¦ï¼Œè®“å§”è¨—äººå®‰å¿ƒã€‚</li>
                                <li><strong>å–„ç”¨å·¥å…·ï¼š</strong>ä½¿ç”¨ Issue Tracker è¨˜éŒ„ä¿®æ”¹éœ€æ±‚èˆ‡æºé€šæ­·ç¨‹ã€‚</li>
                                <li><strong>æª”æ¡ˆç‰ˆæœ¬ï¼š</strong>äº¤ä»˜æª”æ¡ˆæ™‚æ¸…æ¥šæ¨™ç¤ºç‰ˆè™Ÿ (v1, v2...)ã€‚</li>
                            </ul>
                        </div>
                    </div>

                    <div class="accordion-item">
                        <div class="accordion-header" onclick="toggleAccordion(this)">
                            <span>ğŸ‘‰ é‡åˆ°çˆ­è­°æ€éº¼è¾¦ï¼Ÿ</span>
                            <span class="accordion-arrow">&rsaquo;</span>
                        </div>
                        <div class="accordion-content">
                            <p>ä¿æŒç†æ€§æºé€šæ˜¯è§£æ±ºå•é¡Œçš„ç¬¬ä¸€æ­¥ï¼š</p>
                            <ol style="padding-left: 20px; margin-top: 10px;">
                                <li>ç¢ºèªéœ€æ±‚æ˜¯å¦è¶…å‡ºåŸå®šå ±åƒ¹ç¯„åœã€‚</li>
                                <li>è‹¥ç„¡æ³•é”æˆå…±è­˜ï¼Œè«‹å‹¿ç§ä¸‹äº¤æ˜“ã€‚</li>
                                <li>å¯ç”³è«‹å¹³å°ä»‹å…¥ä»²è£ï¼Œä¿éšœé›™æ–¹æ¬Šç›Šã€‚</li>
                            </ol>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>

    <script>
        function toggleAccordion(header) {
            const item = header.parentElement;
            item.classList.toggle('active');
        }

        // æ–°çš„ç¯©é¸å™¨é‚è¼¯
        function setBudget(min, max) {
            document.getElementById('minBudget').value = min || '';
            document.getElementById('maxBudget').value = max || '';
        }

        function toggleFilters() {
            const filters = document.getElementById('advancedFilters');
            const arrow = document.getElementById('filterArrow');
            
            if (filters.style.display === 'none') {
                filters.style.display = 'block';
                // è§¸ç™¼ CSS å‹•ç•« (å¦‚æœæœ‰çš„è©±)
                arrow.innerHTML = 'â–²';
            } else {
                filters.style.display = 'none';
                arrow.innerHTML = 'â–¼';
            }
        }

        function toggleCustomDate(show) {
            const container = document.getElementById('customDateContainer');
            if (show) {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç›£è½ Radio Button è®Šæ›´ï¼Œå¦‚æœé¸äº† 3/7/14 å¤©ï¼Œå°±éš±è—è‡ªè¨‚æ—¥æœŸ
            document.querySelectorAll('input[name="deadline_days"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value !== 'custom') {
                        toggleCustomDate(false);
                    }
                });
            });

            // å¦‚æœ URL è£¡é¢æœ‰é¸ customï¼Œè¼‰å…¥æ™‚è¦æ‰“é–‹æ—¥æœŸé¸å–®
            if (document.getElementById('customDeadlineRadio') && document.getElementById('customDeadlineRadio').checked) {
                toggleCustomDate(true);
            }
        });
    </script>
{% endblock %}
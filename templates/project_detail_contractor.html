{% extends "layout.html" %}

{% block title %}專案詳情: {{ project.title }}{% endblock %}

{% block content %}
    {% if message %}
        <p class="alert alert-success">{{ message }}</p>
    {% endif %}
    {% if error %}
        <p class="alert alert-error">{{ error }}</p>
    {% endif %}

    <div class="content-box">
        <h2>{{ project.title }}</h2>
        <p><strong>委託人：</strong> {{ project.client_name }}</p>
        <p><strong>狀態：</strong> {{ project.status }}</p>
        
        <p><strong>需求描述：</strong><br>
            <span style="white-space: pre-wrap;">{{ project.description }}</span>
        </p>
    </div>
    
    <div class="content-box" style="border-top: 5px solid #ffc107;">
    <h3>⭐ 委託人過去評價</h3>

    {% if client_rating.rating_count > 0 %}
        <p>
            <strong>需求合理性：</strong>
            {{ "%.1f"|format(client_rating.requirement_rationality_avg) }} / 5
        </p>
        <p>
            <strong>驗收難易度：</strong>
            {{ "%.1f"|format(client_rating.acceptance_difficulty_avg) }} / 5
        </p>
        <p>
            <strong>合作態度：</strong>
            {{ "%.1f"|format(client_rating.client_attitude_avg) }} / 5
        </p>
        <p style="color:#666;">
            共 {{ client_rating.rating_count }} 則評價
        </p>

        <hr>

        <h4>近期評論</h4>
        {% for c in client_comments %}
            <div style="margin-bottom: 10px;">
                <div style="font-size: 0.9em; color: #666;">
                    {{ c.rating_date.strftime('%Y-%m-%d') }}
                </div>
                <div>{{ c.overall_comment }}</div>
            </div>
        {% endfor %}

        {% if not client_comments %}
            <p style="color:#999;">尚無文字評論</p>
        {% endif %}

    {% else %}
        <p style="color:#999;">此委託人尚未收到任何評價</p>
    {% endif %}
</div>


    {% if project.status == 'open' and not has_proposed %}
        <div class="content-box">
            <h3>提出承包意願</h3>
            <form method="POST" action="{{ url_for('handle_propose', project_id=project.id) }}">
                <div class="form-group">
                    <label for="quote">我的報價：</label>
                    <input type="number" id="quote" name="quote" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label for="message">給委託人的訊息 ( 選填 )：</label>
                    <textarea id="message" name="message" rows="5"></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">提交報價</button>
                </div>
            </form>
        </div>
    {% elif has_proposed and project.status == 'open' %}
         <p class="alert alert-success">你已對此專案報價，正在等待委託人回應。</p>
    {% endif %}


    {% if (project.status == 'in_progress' or project.status == 'rejected') and project.contractor_id == user.id %}
        <div class="content-box">
            <h3>上傳結案檔案</h3>
            {% if project.status == 'rejected' %}
                <p class="alert alert-error">你的上個檔案已被退件，請修正後重新上傳。</p>
            {% endif %}
            
            <form method="POST" action="{{ url_for('handle_upload_file', project_id=project.id) }}" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">選擇檔案：</label>
                    <input type="file" id="file" name="file" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">上傳檔案並提交驗收</button>
                </div>
            </form>
        </div>
    {% endif %}

    {% if issues %}
    <div class="content-box" style="border-top: 5px solid #28a745;">
        <h2>Issue Tracker (待解決事項)</h2>
        <p>委託人針對此專案提出的問題。請在此回覆並修正檔案。</p>

        {% for issue in issues %}
        <div class="issue-card">
            <div class="issue-header">
                <div>
                    <span class="issue-status-{{ issue.status }}">
                        {{ '已解決' if issue.status == 'resolved' else '待解決' }}
                    </span>
                    <strong style="font-size: 1.1em; margin-left: 10px;">{{ issue.title }}</strong>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">{{ issue.description }}</div>
                </div>
            </div>

            <div class="comments-section">
                {% for comment in issue.comments %}
                    <div class="comment {{ comment.role }}">
                        <div class="comment-meta">{{ comment.username }} ({{ '我' if comment.user_id == user.id else '對方' }}) - {{ comment.created_at.strftime('%m/%d %H:%M') }}</div>
                        {{ comment.message }}
                    </div>
                {% endfor %}
            </div>

            <!-- 加上 project.status != 'completed' 的判斷 -->
            {% if issue.status == 'open' and project.status != 'completed' %}
            <form method="POST" action="{{ url_for('contractor_comment_issue', issue_id=issue.id) }}" style="display: flex; gap: 10px;">
                <input type="text" name="message" placeholder="回覆委託人..." required style="flex-grow: 1;">
                <button type="submit" class="btn btn-secondary btn-sm">送出</button>
            </form>
            {% elif issue.status == 'resolved' %}
                <p style="text-align: center; color: green; font-weight: bold;">此問題已解決</p>
            {% elif project.status == 'completed' %}
                <p style="text-align: center; color: #666;">專案已結案，無法回覆</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
{% if project.status == 'completed' and can_rate %}
<div class="content-box" style="border-top: 5px solid #ffc107;">
    <h3>⭐ 評價委託人</h3>

    <form method="POST" action="/ratings">
        <input type="hidden" name="project_id" value="{{ project.id }}">

        <div class="form-group">
            <label>需求合理性</label>
            <select name="requirement_rationality_score" required>
                {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>驗收難易度</label>
            <select name="acceptance_difficulty_score" required>
                {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>合作態度</label>
            <select name="client_attitude_score" required>
                {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>整體評論</label>
            <textarea name="overall_comment" rows="3"></textarea>
        </div>

        <button type="submit" class="btn btn-primary">
            送出評價
        </button>
    </form>
</div>
{% endif %}




    
    {% if project.status == 'pending_approval' %}
        <p class="alert alert-success">檔案已提交，正在等待委託人驗收。</p>
    {% elif project.status == 'completed' %}
        <p class="alert alert-success">此專案已結案。</p>
    {% endif %}

    <br>
    <a href="{{ url_for('get_contractor_dashboard') }}" class="btn btn-secondary">返回儀表板</a>
{% endblock %}
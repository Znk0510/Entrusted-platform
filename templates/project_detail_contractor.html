{% extends "layout.html" %}

{% block title %}å°ˆæ¡ˆè©³æƒ…: {{ project.title }}{% endblock %}

{% block content %}
    {% if message %}
        <p class="alert alert-success">{{ message }}</p>
    {% endif %}
    {% if error %}
        <p class="alert alert-error">{{ error }}</p>
    {% endif %}

    <div class="content-box">
        <h2>{{ project.title }}</h2>
        <p><strong>å§”è¨—äººï¼š</strong> {{ project.client_name }}</p>
        <p><strong>ç‹€æ…‹ï¼š</strong> 
            {% if project.status == 'open' %}é–‹æ”¾ææ¡ˆä¸­
            {% elif project.status == 'in_progress' %}é€²è¡Œä¸­
            {% elif project.status == 'pending_approval' %}ç­‰å¾…é©—æ”¶
            {% elif project.status == 'rejected' %}å·²é€€ä»¶ (éœ€ä¿®æ”¹)
            {% elif project.status == 'completed' %}å·²çµæ¡ˆ
            {% else %}{{ project.status }}{% endif %}
        </p>
        <p><strong>ææ¡ˆæˆªæ­¢æ—¥æœŸï¼š</strong> 
            {% if project.deadline %}
                {{ project.deadline.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
                ç„¡æˆªæ­¢æœŸé™
            {% endif %}
        </p>
        
        <p><strong>éœ€æ±‚æè¿°ï¼š</strong><br>
            <span style="white-space: pre-wrap;">{{ project.description }}</span>
        </p>
    </div>

    {% if project.status == 'open' and not has_proposed %}
        <div class="content-box">
            <h3>æå‡ºæ‰¿åŒ…æ„é¡˜</h3>
            <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                è«‹å¡«å¯«å ±åƒ¹ä¸¦ä¸Šå‚³æ‚¨çš„ææ¡ˆè¨ˆç•«æ›¸ (PDF)ã€‚
            </p>

            <form method="POST" action="{{ url_for('handle_propose', project_id=project.id) }}" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="quote">æˆ‘çš„å ±åƒ¹ (NT$)ï¼š</label>
                    <input type="number" id="quote" name="quote" step="1" min="0" required placeholder="ä¾‹å¦‚ï¼š5000">
                </div>
                
                <div class="form-group">
                    <label for="proposal_pdf">ææ¡ˆè¨ˆç•«æ›¸ (é™ PDF)ï¼š</label>
                    <input type="file" id="proposal_pdf" name="proposal_pdf" accept=".pdf" required>
                </div>

                <div class="form-group">
                    <label for="message">çµ¦å§”è¨—äººçš„è¨Šæ¯ (é¸å¡«)ï¼š</label>
                    <textarea id="message" name="message" rows="5" placeholder="ç°¡è¿°æ‚¨çš„å„ªå‹¢æˆ–åŸ·è¡Œæ–¹å‘..."></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">æäº¤å ±åƒ¹èˆ‡è¨ˆç•«æ›¸</button>
                </div>
            </form>
        </div>
    
    {% elif has_proposed and project.status == 'open' %}
         <div class="content-box" style="text-align: center; border-left: 5px solid var(--primary-color);">
            <h3>âœ… å·²é€å‡ºææ¡ˆ</h3>
            <p>æ‚¨å·²å°æ­¤å°ˆæ¡ˆå ±åƒ¹ï¼Œè«‹è€å¿ƒç­‰å¾…å§”è¨—äººå›æ‡‰ã€‚</p>
         </div>
    {% endif %}


    {% if (project.status == 'in_progress' or project.status == 'rejected' or project.status == 'pending_approval') and project.contractor_id == user.id %}
    <div class="content-box">
        <h3>
            {% if project.status == 'rejected' %}
                âš ï¸ ä¿®æ­£ä¸¦é‡æ–°ä¸Šå‚³æª”æ¡ˆ
            {% elif project.status == 'pending_approval' %}
                ğŸ”„ æ›´æ–°ç‰ˆæœ¬ (ç›®å‰æ­£åœ¨ç­‰å¾…é©—æ”¶)
            {% else %}
                ä¸Šå‚³çµæ¡ˆæˆæœ
            {% endif %}
        </h3>

        {% if project.status == 'rejected' %}
            <p class="alert alert-error">
                <strong>æ³¨æ„ï¼š</strong> æ‚¨çš„ä¸Šä¸€å€‹ç‰ˆæœ¬å·²è¢«å§”è¨—äººé€€å›ã€‚è«‹åƒè€ƒ Issue è¨è«–é€²è¡Œä¿®æ”¹ã€‚
            </p>
        {% elif project.status == 'pending_approval' %}
            <p class="alert alert-info" style="background-color: #e2e3e5; color: #383d41; border-color: #d6d8db;">
                <strong>æç¤ºï¼š</strong> æ‚¨å·²æäº¤éæª”æ¡ˆã€‚è‹¥æœ‰ä¿®æ”¹ï¼Œå¯åœ¨æ­¤ç›´æ¥ä¸Šå‚³æ–°ç‰ˆæœ¬è¦†è“‹èˆŠçš„è«‹æ±‚ã€‚
            </p>
        {% else %}
            <p style="margin-bottom: 15px;">è«‹å°‡å®Œæˆçš„æˆæœæ‰“åŒ…ä¸Šå‚³ã€‚ç³»çµ±æœƒè‡ªå‹•ä¿ç•™èˆŠç‰ˆæœ¬ç´€éŒ„ã€‚</p>
        {% endif %}
        
        <form method="POST" action="{{ url_for('upload_project_file', project_id=project.id) }}" enctype="multipart/form-data">
            <div class="form-group">
                <label for="file">é¸æ“‡æª”æ¡ˆ (å»ºè­°ä¸Šå‚³ ZIP æˆ– PDF)ï¼š</label>
                <input type="file" id="file" name="file" required>
            </div>
            
            <div class="form-group">
                <button type="submit" class="btn btn-primary">
                    {% if project.status == 'pending_approval' %}
                        ä¸Šå‚³æ–°ç‰ˆæœ¬
                    {% else %}
                        ä¸Šå‚³æª”æ¡ˆä¸¦æäº¤é©—æ”¶
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
{% endif %}

    {% if issues %}
    <div class="content-box" style="border-top: 5px solid #28a745;">
        <h2>Issue Tracker (å¾…è§£æ±ºäº‹é …)</h2>
        <p>å§”è¨—äººé‡å°æ­¤å°ˆæ¡ˆæå‡ºçš„å•é¡Œèˆ‡å›é¥‹ã€‚</p>

        {% for issue in issues %}
        <div class="issue-card">
            <div class="issue-header">
                <div>
                    <span class="issue-status-{{ issue.status }}">
                        {{ 'å·²è§£æ±º' if issue.status == 'resolved' else 'å¾…è§£æ±º' }}
                    </span>
                    <strong style="font-size: 1.1em; margin-left: 10px;">{{ issue.title }}</strong>
                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">{{ issue.description }}</div>
                </div>
            </div>

            <div class="comments-section">
                {% for comment in issue.comments %}
                    <div class="comment {{ comment.role }}">
                        <div class="comment-meta">{{ comment.username }} ({{ 'æˆ‘' if comment.user_id == user.id else 'å°æ–¹' }}) - {{ comment.created_at.strftime('%m/%d %H:%M') }}</div>
                        {{ comment.message }}
                    </div>
                {% endfor %}
            </div>

            {% if issue.status == 'open' and project.status != 'completed' %}
            <form method="POST" action="{{ url_for('contractor_comment_issue', issue_id=issue.id) }}" style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" name="message" placeholder="å›è¦†å§”è¨—äºº..." required style="flex-grow: 1; padding: 8px;">
                <button type="submit" class="btn btn-secondary btn-sm">é€å‡º</button>
            </form>
            {% elif issue.status == 'resolved' %}
                <p style="text-align: center; color: green; font-weight: bold; margin-top: 10px;">æ­¤å•é¡Œå·²æ¨™è¨˜ç‚ºè§£æ±º</p>
            {% elif project.status == 'completed' %}
                <p style="text-align: center; color: #666; margin-top: 10px;">å°ˆæ¡ˆå·²çµæ¡ˆ</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if project.status == 'pending_approval' %}
        <div class="alert alert-success" style="text-align: center; font-size: 1.1em;">
            <strong>å·²æäº¤ï¼</strong> æª”æ¡ˆæ­£åœ¨ç­‰å¾…å§”è¨—äººé©—æ”¶ã€‚
        </div>
    {% elif project.status == 'completed' %}
        <div class="alert alert-success" style="text-align: center; font-size: 1.1em;">
            ğŸ‰ æ­å–œï¼æ­¤å°ˆæ¡ˆå·²é †åˆ©çµæ¡ˆã€‚
        </div>
    {% endif %}

    <br>
    <a href="{{ url_for('get_contractor_dashboard') }}" class="btn btn-secondary">è¿”å›å„€è¡¨æ¿</a>
{% endblock %}
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œå§”è¨—å¹³å° - {% block title %}{% endblock %}</title>
    
    <link rel="stylesheet" href="{{ url_for('static', path='style.css') }}">

</head>
<body>
    
    <header class="navbar">
        <div class="container">
            <a href="{{ url_for('root') }}" class="logo">å·¥ä½œå§”è¨—å¹³å°</a>
            
            <ul class="nav-links">
                <li><a href="{{ url_for('get_support_page') }}">å®¢æœä¸­å¿ƒ</a></li>

                {% if user %}
                    <li>
                        {% if user.avatar %}
                            <img src="/{{ user.avatar }}" class="avatar-small" alt="Avatar">
                        {% endif %}
                        
                        <a href="{{ url_for('view_user_profile', user_id=user.id) }}" style="font-weight: bold;">
                            {{ user.username }} ({{ user.role }})
                        </a>
                    </li>
                    <li><a href="{{ url_for('edit_my_profile_page') }}">è¨­å®š</a></li>
                    <li><a href="{{ url_for('handle_logout') }}">ç™»å‡º</a></li>
                {% else %}
                    <li><a href="{{ url_for('get_login_page') }}">ç™»å…¥</a></li>
                    <li><a href="{{ url_for('get_register_page') }}">è¨»å†Š</a></li>
                {% endif %}
            </ul>
        </div>
    </header>

    <main class="container">
        {% block content %}{% endblock %}
    </main>

    <footer>
        <p>&copy; 2025 å·¥ä½œå§”è¨—å¹³å°</p>
    </footer>

    <div id="user-preview-popup">
        <div class="preview-content">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="ai-widget-btn" onclick="toggleAIChat()">
        ğŸ¤–
    </div>

    <div class="ai-chat-box" id="aiChatBox">
        <div class="ai-chat-header">
            <span>ğŸ¤– å°ˆæ¡ˆæè¿°å°åŠ©æ‰‹</span>
            <span class="ai-close-btn" onclick="toggleAIChat()">Ã—</span>
        </div>
        
        <div class="ai-chat-body" id="aiChatBody">
            <div class="chat-bubble ai">
                å—¨ï¼æˆ‘æ˜¯æ‚¨çš„ AI åŠ©æ‰‹ã€‚<br>
                ä¸çŸ¥é“æ€éº¼å¯«éœ€æ±‚å—ï¼Ÿå‘Šè¨´æˆ‘ä½ æƒ³åšä»€éº¼ï¼Œæˆ‘å¹«ä½ å¯«å‡ºå°ˆæ¥­çš„æè¿°ï¼
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">AI æ­£åœ¨æ€è€ƒä¸­...</div>

        <div class="ai-chat-footer">
            <input type="text" id="aiInput" class="ai-chat-input" placeholder="è¼¸å…¥æ‚¨çš„æƒ³æ³•..." onkeypress="handleAIKeyPress(event)">
            <button class="ai-send-btn" onclick="sendAIMessage()">â¤</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            /* -----------------------------------
               1. ä½¿ç”¨è€…é è¦½é‚è¼¯
               ----------------------------------- */
            const popup = document.getElementById('user-preview-popup');
            let fetchTimeout;

            // ç›£è½æ‰€æœ‰å¸¶æœ‰ .user-link çš„å…ƒç´ 
            document.body.addEventListener('mouseover', function(e) {
                const target = e.target.closest('.user-link');
                if (!target) {
                    popup.classList.remove('show');
                    return;
                }

                const userId = target.getAttribute('data-id');
                if (!userId) return;

                // å®šä½æ¡†æ¡†
                const rect = target.getBoundingClientRect();
                const scrollY = window.scrollY;
                const scrollX = window.scrollX;

                popup.style.top = (rect.bottom + scrollY + 10) + 'px';
                popup.style.left = (rect.left + scrollX) + 'px';
                popup.classList.add('show');
                popup.innerHTML = '<p style="color:#888; text-align:center;">è¼‰å…¥ä¸­...</p>';

                // å‘¼å« API
                clearTimeout(fetchTimeout);
                fetchTimeout = setTimeout(() => {
                    fetch(`/users/api/preview/${userId}`)
                        .then(res => res.json())
                        .then(data => {
                            if(data.error) return;
                            
                            const avatarImg = data.avatar 
                                ? `<img src="${data.avatar}" class="preview-avatar">` 
                                : `<div class="preview-avatar" style="background:#eee; display:flex; align-items:center; justify-content:center; font-weight:bold;">${data.username[0].toUpperCase()}</div>`;

                            popup.innerHTML = `
                                <div class="preview-header">
                                    ${avatarImg}
                                    <div class="preview-info">
                                        <h4>${data.username}</h4>
                                        <span class="preview-role">${data.role}</span>
                                    </div>
                                </div>
                                <div class="preview-stats">
                                    <span>è©•åˆ†: <strong style="color:#ffc107;">${data.stats.rating}</strong></span>
                                    <span>(${data.stats.count} å‰‡è©•åƒ¹)</span>
                                </div>
                            `;
                        });
                }, 100);
            });

            document.body.addEventListener('mouseout', function(e) {
                if (!e.target.closest('.user-link')) {
                    popup.classList.remove('show');
                    clearTimeout(fetchTimeout);
                }
            });
        });

        /* -----------------------------------
           2. AI å°åŠ©æ‰‹é‚è¼¯ [æœ¬æ¬¡æ–°å¢]
           ----------------------------------- */
        
        // åˆ‡æ›é¡¯ç¤º/éš±è—
        function toggleAIChat() {
            const box = document.getElementById('aiChatBox');
            box.classList.toggle('show');
            
            // è‡ªå‹•èšç„¦è¼¸å…¥æ¡†
            if (box.classList.contains('show')) {
                setTimeout(() => document.getElementById('aiInput').focus(), 300);
            }
        }

        // è™•ç† Enter éµ
        function handleAIKeyPress(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        }

        // ç™¼é€è¨Šæ¯é‚è¼¯
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const body = document.getElementById('aiChatBody');
            const message = input.value.trim();

            if (!message) return;

            // é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
            addMessage(message, 'user');
            input.value = '';

            // é¡¯ç¤ºè¼‰å…¥ä¸­
            document.getElementById('typingIndicator').style.display = 'block';
            body.scrollTop = body.scrollHeight; // æ²å‹•åˆ°åº•éƒ¨

            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // é¡¯ç¤º AI å›è¦†
                if (data.reply) {
                    // å°‡æ›è¡Œç¬¦è™Ÿè½‰æ›ç‚º <br> ä»¥ä¾¿åœ¨ HTML é¡¯ç¤º
                    const formattedReply = data.reply.replace(/\n/g, '<br>');
                    addMessage(formattedReply, 'ai');
                } else {
                    addMessage("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚", 'ai');
                }

            } catch (error) {
                console.error('Error:', error);
                addMessage("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API Keyã€‚", 'ai');
            } finally {
                document.getElementById('typingIndicator').style.display = 'none';
            }
        }

        // è¼”åŠ©ï¼šæ–°å¢è¨Šæ¯åˆ°ç•«é¢
        function addMessage(text, sender) {
            const body = document.getElementById('aiChatBody');
            const div = document.createElement('div');
            div.classList.add('chat-bubble', sender);
            div.innerHTML = text; 
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }
    </script>
</body>
</html>
{% extends "layout.html" %}

{% block title %}å°ˆæ¡ˆè©³æƒ…: {{ project.title }}{% endblock %}

{% block content %}

    {% if message %}
        <p class="alert alert-success">{{ message }}</p>
    {% endif %}
    {% if error %}
        <p class="alert alert-error">{{ error }}</p>
    {% endif %}

    <div class="stepper-wrapper" style="margin-top: 20px; margin-bottom: 40px;">
        <div class="stepper-item {{ 'completed' if project.status in ['in_progress', 'pending_approval', 'completed', 'rejected'] else ('active' if project.status == 'open') }}">
            <div class="step-counter">1</div>
            <div class="step-name">é–‹æ”¾ææ¡ˆ</div>
        </div>
        <div class="stepper-item {{ 'completed' if project.status in ['pending_approval', 'completed'] else ('active' if project.status == 'in_progress' or project.status == 'rejected') }}">
            <div class="step-counter">2</div>
            <div class="step-name">åŸ·è¡Œè£½ä½œ</div>
        </div>
        <div class="stepper-item {{ 'completed' if project.status == 'completed' else ('active' if project.status == 'pending_approval') }}">
            <div class="step-counter">3</div>
            <div class="step-name">é©—æ”¶éšæ®µ</div>
        </div>
        <div class="stepper-item {{ 'active' if project.status == 'completed' }}">
            <div class="step-counter">4</div>
            <div class="step-name">é †åˆ©çµæ¡ˆ</div>
        </div>
    </div>

    <div class="detail-layout-grid">
        
        <div class="detail-main">
            
            <div class="content-box" style="margin: 0;">
                <h2 style="margin-bottom: 15px;">{{ project.title }}</h2>
                <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px;">
                
                <h4 style="margin-bottom: 10px; color: var(--primary-color);">éœ€æ±‚è©³æƒ…</h4>
                <p style="white-space: pre-wrap; color: #555; line-height: 1.8;">{{ project.description }}</p>
            </div>

            {% if project.status == 'open' %}
                <div class="content-box" style="margin: 0; background-color: #f8fbff; border: 1px solid #dbeafe;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">æ”¶åˆ°çš„ææ¡ˆ ({{ proposals|length }})</h3>
                    </div>
                    
                    {% if proposals %}
                        <div class="proposal-grid">
                            {% for p in proposals %}
                            <div class="proposal-card">
                                <div class="proposal-header">
                                    <div class="user-info">
                                        <div class="avatar-placeholder">{{ p.contractor_name[0]|upper }}</div>
                                        <div>
                                            <a href="{{ url_for('view_user_profile', user_id=p.contractor_id) }}" 
                                               class="user-link" 
                                               data-id="{{ p.contractor_id }}"
                                               style="font-weight: bold; color: var(--dark-text);">
                                                {{ p.contractor_name }}
                                            </a>
                                        </div>
                                    </div>
                                    <div class="proposal-price">
                                        <span class="price-tag">${{ "%.0f"|format(p.quote) }}</span>
                                    </div>
                                </div>
                                <div class="proposal-body">
                                    <p class="message-preview">"{{ p.message }}"</p>
                                    {% if p.proposal_file %}
                                        <a href="/client/download?path={{ p.proposal_file }}" target="_blank" class="file-tag">ğŸ“„ ä¸‹è¼‰è¨ˆç•«æ›¸</a>
                                    {% endif %}
                                </div>
                                <div class="proposal-footer">
                                    <form method="POST" action="{{ url_for('select_proposal', project_id=project.id, proposal_id=p.id) }}" style="margin: 0;">
                                        <button type="submit" class="btn btn-primary" style="width: 100%;" onclick="return confirm('ç¢ºå®šè¦é¸æ“‡é€™ä½æ¥æ¡ˆäººå—ï¼Ÿ')">
                                            ğŸ¤ é¸æ“‡æ­¤ææ¡ˆ
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p style="color: #888; text-align: center; padding: 20px;">ç›®å‰å°šæœªæ”¶åˆ°ææ¡ˆã€‚</p>
                    {% endif %}
                </div>
            {% endif %}

            {% if project.status != 'open' %}
            <div class="content-box" style="margin: 0;">
                <h3 style="margin-bottom: 15px;">ğŸ“‚ æª”æ¡ˆç‰ˆæœ¬ç´€éŒ„</h3>
                {% if files %}
                    <table class="table-styled" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>æª”å</th>
                                <th>ç‰ˆè™Ÿ</th>
                                <th>æ™‚é–“</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in files %}
                                <tr>
                                    <td>{{ file.filename }}</td>
                                    <td>v{{ file.id }}</td>
                                    <td>{{ file.uploaded_at.strftime('%m/%d %H:%M') }}</td>
                                    <td><a href="/client/download?path={{ file.filepath }}" target="_blank" class="btn btn-secondary btn-sm">ä¸‹è¼‰</a></td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p style="color: #888;">ç›®å‰æ²’æœ‰å·²ä¸Šå‚³çš„æª”æ¡ˆã€‚</p>
                {% endif %}
            </div>
            {% endif %}

            {% if project.status != 'open' %}
            <div class="content-box" style="margin: 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0;">Issue Tracker (æºé€šç´€éŒ„)</h3>
                    {% if project.status != 'completed' %}
                        <button onclick="document.getElementById('new-issue-form').style.display='block'" class="btn btn-secondary btn-sm">+ æ–°å¢å•é¡Œ</button>
                    {% endif %}
                </div>
                {% if project.status != 'completed' %}
                <div id="new-issue-form" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <form method="POST" action="{{ url_for('create_issue', project_id=project.id) }}">
                        <input type="text" name="title" placeholder="æ¨™é¡Œ..." required style="width: 100%; padding: 8px; margin-bottom: 10px;">
                        <textarea name="description" placeholder="æè¿°..." rows="2" required style="width: 100%; padding: 8px; margin-bottom: 10px;"></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">ç™¼å¸ƒ</button>
                    </form>
                </div>
                {% endif %}

                {% if issues %}
                    {% for issue in issues %}
                    <div class="issue-card">
                        <div class="issue-header">
                            <div>
                                <span class="issue-status-{{ issue.status }}">{{ 'å·²è§£æ±º' if issue.status == 'resolved' else 'å¾…è§£æ±º' }}</span>
                                <strong style="margin-left: 10px;">{{ issue.title }}</strong>
                            </div>
                            {% if issue.status == 'open' and project.status != 'completed' %}
                            <form method="POST" action="{{ url_for('resolve_issue', issue_id=issue.id) }}">
                                <button type="submit" class="btn btn-sm" style="color: green; background: none; border: 1px solid green;">âœ” æ¨™è¨˜è§£æ±º</button>
                            </form>
                            {% endif %}
                        </div>
                        <p style="color: #666; margin: 10px 0;">{{ issue.description }}</p>
                        <div class="comments-section" style="background: #fafafa; padding: 10px;">
                            {% for comment in issue.comments %}
                                <div class="comment">
                                    <strong>{{ 'æˆ‘' if comment.user_id == project.client_id else 'æ¥æ¡ˆäºº' }}:</strong> {{ comment.message }}
                                </div>
                            {% endfor %}
                        </div>
                        {% if issue.status == 'open' %}
                        <form method="POST" action="{{ url_for('client_comment_issue', issue_id=issue.id) }}" style="display: flex; gap: 10px; margin-top: 10px;">
                            <input type="text" name="message" placeholder="å›è¦†..." required style="flex-grow: 1; padding: 5px;">
                            <button type="submit" class="btn btn-secondary btn-sm">é€å‡º</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #aaa;">å°šç„¡ Issue ç´€éŒ„ã€‚</p>
                {% endif %}
            </div>
            {% endif %}

        </div> <div class="detail-sidebar">
            
            <div class="sidebar-card">
                <span class="sidebar-label">ç›®å‰ç‹€æ…‹</span>
                <div style="margin-bottom: 15px;">
                    {% if project.status == 'open' %}
                        <span class="status-badge status-open" style="font-size: 1em; margin:0;">é–‹æ”¾ææ¡ˆä¸­</span>
                    {% elif project.status == 'in_progress' %}
                        <span class="status-badge status-progress" style="font-size: 1em; margin:0;">é€²è¡Œä¸­</span>
                    {% elif project.status == 'pending_approval' %}
                        <span class="status-badge status-pending" style="font-size: 1em; margin:0;">ç­‰å¾…é©—æ”¶</span>
                    {% elif project.status == 'completed' %}
                        <span class="status-badge status-completed" style="font-size: 1em; margin:0;">å·²çµæ¡ˆ</span>
                    {% endif %}
                </div>

                <span class="sidebar-label">é ç®—ç¯„åœ</span>
                <div class="sidebar-value" style="margin-bottom: 15px; color: #2e7d32;">
                    {{ project.budget if project.budget else 'æœªè¨­å®š' }}
                </div>

                <span class="sidebar-label">ææ¡ˆæˆªæ­¢æ—¥æœŸ</span>
                <div class="sidebar-value" style="margin-bottom: 15px;">
                    {{ project.deadline.strftime('%Y-%m-%d %H:%M') if project.deadline else 'ç„¡' }}
                </div>

                <span class="sidebar-label">å§”è¨—äºº</span>
                <div class="sidebar-value">
                    {{ project.client_name }}
                </div>
            </div>

            <div class="sidebar-card">
                <span class="sidebar-label">å°ˆæ¡ˆæ“ä½œ</span>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    {% if project.status == 'open' %}
                        <a href="{{ url_for('get_edit_project_page', project_id=project.id) }}" class="btn btn-secondary" style="text-align: center;">
                            âœï¸ ç·¨è¼¯å°ˆæ¡ˆ
                        </a>
                    {% endif %}
                    
                    {% if project.status == 'pending_approval' %}
                        <form method="POST" action="{{ url_for('approve_project', project_id=project.id) }}" style="width: 100%;">
                            <button type="submit" class="btn btn-primary" style="width: 100%;">âœ… é©—æ”¶é€šé</button>
                        </form>
                        <form method="POST" action="{{ url_for('reject_project', project_id=project.id) }}" style="width: 100%;">
                            <button type="submit" class="btn" style="width: 100%; background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2;">âŒ é€€ä»¶ä¿®æ”¹</button>
                        </form>
                    {% endif %}

                    {% if project.status == 'completed' %}
                        
                        {% if my_review %}
                            <div class="content-box" style="border-top: 5px solid #28a745; background-color: #f9fff9; padding: 15px;">
                                <h4 style="color: #28a745; margin-top:0;">âœ… æ‚¨å·²è©•åƒ¹</h4>
                                
                                <div style="opacity: 0.8; pointer-events: none;">
                                    <div style="margin-bottom: 10px;">
                                        <label style="font-size: 0.9em; display:block;">ç”¢å‡ºå“è³ª <span style="float:right; color:#28a745; font-weight:bold;">{{ my_review.rating_1 }}</span></label>
                                        <input type="range" min="1" max="5" value="{{ my_review.rating_1 }}" disabled style="width:100%;">
                                    </div>

                                    <div style="margin-bottom: 10px;">
                                        <label style="font-size: 0.9em; display:block;">åŸ·è¡Œæ•ˆç‡ <span style="float:right; color:#28a745; font-weight:bold;">{{ my_review.rating_2 }}</span></label>
                                        <input type="range" min="1" max="5" value="{{ my_review.rating_2 }}" disabled style="width:100%;">
                                    </div>

                                    <div style="margin-bottom: 10px;">
                                        <label style="font-size: 0.9em; display:block;">åˆä½œæ…‹åº¦ <span style="float:right; color:#28a745; font-weight:bold;">{{ my_review.rating_3 }}</span></label>
                                        <input type="range" min="1" max="5" value="{{ my_review.rating_3 }}" disabled style="width:100%;">
                                    </div>
                                </div>

                                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc;">
                                    <strong style="font-size: 0.9em;">æ‚¨çš„è©•è«–ï¼š</strong>
                                    <p style="font-size: 0.9em; color: #555; margin-top: 5px;">{{ my_review.comment }}</p>
                                </div>
                            </div>

                        {% else %}
                            <div class="content-box" style="border-top: 5px solid #ffc107; padding: 15px;">
                                <h4 style="margin-top:0;">â­ è©•åƒ¹æ¥æ¡ˆäºº</h4>
                                <p style="font-size: 0.9em; margin-bottom: 10px;">è«‹å° <strong>{{ project.contractor_name }}</strong> è©•åˆ†ã€‚</p>
                                
                                <form method="POST" action="{{ url_for('submit_review', project_id=project.id) }}">
                                    
                                    <div class="rating-group" style="padding: 0; background: none; margin-bottom: 5px;">
                                        <label style="font-size: 0.9em;">ç”¢å‡ºå“è³ª <span style="float:right; color:var(--primary-color);">5</span></label>
                                        <input type="range" name="rating_1" min="1" max="5" value="5" oninput="this.previousElementSibling.children[0].textContent = this.value">
                                    </div>

                                    <div class="rating-group" style="padding: 0; background: none; margin-bottom: 5px;">
                                        <label style="font-size: 0.9em;">åŸ·è¡Œæ•ˆç‡ <span style="float:right; color:var(--primary-color);">5</span></label>
                                        <input type="range" name="rating_2" min="1" max="5" value="5" oninput="this.previousElementSibling.children[0].textContent = this.value">
                                    </div>

                                    <div class="rating-group" style="padding: 0; background: none; margin-bottom: 5px;">
                                        <label style="font-size: 0.9em;">åˆä½œæ…‹åº¦ <span style="float:right; color:var(--primary-color);">5</span></label>
                                        <input type="range" name="rating_3" min="1" max="5" value="5" oninput="this.previousElementSibling.children[0].textContent = this.value">
                                    </div>

                                    <div class="form-group" style="margin-bottom: 10px;">
                                        <textarea name="comment" rows="3" required placeholder="å¯«ä¸‹è©•è«–..." style="width: 100%; font-size: 0.9em; padding: 8px;"></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-primary btn-sm" style="width: 100%;">é€å‡ºè©•åƒ¹</button>
                                </form>
                            </div>
                        {% endif %}

                    {% endif %}
                </div>
            </div>
            <!--
            <a href="{{ url_for('get_client_dashboard') }}" style="text-align: center; display: block; color: #666; font-size: 0.9em;">
                â† è¿”å›å„€è¡¨æ¿
            </a>
            -->
            <a href="{{ url_for('get_client_dashboard') }}" class="btn btn-secondary">è¿”å›å„€è¡¨æ¿</a>
        </div> </div> {% endblock %}